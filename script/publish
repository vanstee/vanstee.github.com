#!/usr/bin/env bash

DEFAULT_BRANCH=${DEFAULT_BRANCH:-"master"}
PUSH=${PUSH:-"true"}

set -e

# Check for uncommitted changes
if [ -n "$(git status --porcelain)" ]; then
  echo "Please commit your changes and try again."
  exit 1
fi

# Generate public directory
stasis

# Create commit with generated files
git add -A public/
tree=$(git write-tree --missing-ok --prefix=public/)

# Apply commit to $DEFAULT_BRANCH
previous_commit=$(git rev-parse HEAD)
commit=$(echo "Publishes: $previous_commit" | git commit-tree $tree -p $DEFAULT_BRANCH)
git update-ref refs/heads/$DEFAULT_BRANCH $commit

# Push changes to remote/$DEFAULT_BRANCH
if [ "$PUSH" == "true" ]; then
  git push origin $DEFAULT_BRANCH
fi

# Clean up after ourselves
git reset HEAD
git checkout .
rm -rf public/

set +e
